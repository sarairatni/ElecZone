import psycopg2
from dotenv import load_dotenv
import os
from faker import Faker
import random

# Load environment variables from .env
load_dotenv()

# Fetch variables
USER = os.getenv("user")
PASSWORD = os.getenv("password")
HOST = os.getenv("host")
PORT = os.getenv("port")
DBNAME = os.getenv("dbname")

# Initialize Faker
fake = Faker(['fr_FR', 'en_US'])  # Mix fran√ßais et anglais

# D√©finir les cat√©gories avec des termes sp√©cifiques pour la g√©n√©ration
CATEGORIES = {
    1: {
        'name': 'T√©l√©phones',
        'prefixes': ['Smart', 'Pro', 'Ultra', 'Max', 'Plus', 'Elite', 'Prime'],
        'suffixes': ['Phone', 'Mobile', 'Cell', 'Device', 'Smartphone'],
        'tech_words': ['5G', 'AI', 'Quantum', 'Nano', 'Turbo', 'Infinity']
    },
    2: {
        'name': 'R√©frig√©rateur',
        'prefixes': ['Cool', 'Fresh', 'Ice', 'Frost', 'Chill', 'Arctic', 'Zero'],
        'suffixes': ['Fridge', 'Cooler', 'Refrigerator', 'Fresh', 'Box'],
        'tech_words': ['Eco', 'Smart', 'Digital', 'Auto', 'Multi', 'Twin']
    },
    3: {
        'name': 'Laptops',
        'prefixes': ['Book', 'Pad', 'Pro', 'Air', 'Ultra', 'Slim', 'Power'],
        'suffixes': ['Book', 'Pad', 'Top', 'Machine', 'Station', 'Elite'],
        'tech_words': ['Core', 'Turbo', 'Quantum', 'Speed', 'Performance', 'Gaming']
    },
    4: {
        'name': 'Cameras',
        'prefixes': ['Focus', 'Snap', 'Shot', 'Lens', 'Vision', 'Photo', 'Image'],
        'suffixes': ['Cam', 'Shot', 'Focus', 'Lens', 'Vision', 'Pro'],
        'tech_words': ['HD', '4K', '8K', 'Pro', 'Ultra', 'Zoom', 'Digital']
    },
    5: {
        'name': 'Cuisini√®re',
        'prefixes': ['Cook', 'Chef', 'Master', 'Gourmet', 'Kitchen', 'Culinary'],
        'suffixes': ['Cook', 'Chef', 'Master', 'Pro', 'Elite', 'Station'],
        'tech_words': ['Induction', 'Gas', 'Electric', 'Smart', 'Auto', 'Digital']
    },
    6: {
        'name': 'Air Conditioners',
        'prefixes': ['Cool', 'Air', 'Climate', 'Comfort', 'Fresh', 'Breeze'],
        'suffixes': ['Air', 'Cool', 'Climate', 'Comfort', 'System', 'Unit'],
        'tech_words': ['Inverter', 'Eco', 'Smart', 'Silent', 'Turbo', 'Auto']
    },
    8: {
        'name': 'TVs',
        'prefixes': ['Vision', 'View', 'Screen', 'Display', 'Smart', 'Ultra'],
        'suffixes': ['TV', 'Vision', 'Display', 'Screen', 'View', 'Entertainment'],
        'tech_words': ['4K', '8K', 'OLED', 'QLED', 'HDR', 'Smart', 'Ultra']
    }
}

def generate_faker_product_name(category_id):
    """G√©n√®re un nom de produit enti√®rement avec Faker"""
    category_info = CATEGORIES[category_id]
    
    # Diff√©rentes fa√ßons de g√©n√©rer un nom
    generation_methods = [
        # M√©thode 1: Marque + Pr√©fixe + Suffixe
        lambda: f"{fake.company().split()[0]} {random.choice(category_info['prefixes'])}{random.choice(category_info['suffixes'])}",
        
        # M√©thode 2: Marque + Tech Word + Mod√®le
        lambda: f"{fake.company().split()[0]} {random.choice(category_info['tech_words'])} {fake.word().capitalize()}",
        
        # M√©thode 3: Pr√©fixe + Tech Word + Nombre
        lambda: f"{random.choice(category_info['prefixes'])}{random.choice(category_info['tech_words'])} {random.randint(100, 9999)}",
        
        # M√©thode 4: Marque + Pr√©fixe + Tech Word
        lambda: f"{fake.last_name()} {random.choice(category_info['prefixes'])} {random.choice(category_info['tech_words'])}",
        
        # M√©thode 5: Tech Word + Marque + Suffixe
        lambda: f"{random.choice(category_info['tech_words'])} {fake.company().split()[0]} {random.choice(category_info['suffixes'])}",
        
        # M√©thode 6: Couleur + Pr√©fixe + Suffixe
        lambda: f"{fake.color_name().capitalize()} {random.choice(category_info['prefixes'])}{random.choice(category_info['suffixes'])}",
        
        # M√©thode 7: Ann√©e + Marque + Mod√®le
        lambda: f"{random.randint(2020, 2024)} {fake.last_name()} {random.choice(category_info['prefixes'])} {random.choice(category_info['tech_words'])}"
    ]
    
    # Choisir une m√©thode al√©atoire
    chosen_method = random.choice(generation_methods)
    name = chosen_method()
    
    # Nettoyer le nom (enlever les caract√®res sp√©ciaux, limiter la longueur)
    name = ''.join(char for char in name if char.isalnum() or char.isspace())
    name = ' '.join(name.split())  # Normaliser les espaces
    
    return name[:50]  # Limiter √† 50 caract√®res

def generate_faker_description():
    """G√©n√®re une description enti√®rement avec Faker"""
    
    # Composants de description
    opening_phrases = [
        fake.catch_phrase(),
        f"D√©couvrez {fake.bs()}",
        f"Innovation {fake.word()}",
        f"Technologie {fake.word()} avanc√©e"
    ]
    
    features = [
        f"‚úì {fake.bs()}",
        f"‚úì Design {fake.color_name()}",  
        f"‚úì Garantie {random.choice(['1 an', '2 ans', '3 ans', '5 ans'])}",
        f"‚úì {fake.catch_phrase()}",
        f"‚úì Efficacit√© √©nerg√©tique {random.choice(['A+', 'A++', 'A+++'])}",
        f"‚úì {fake.company()} certified",
        f"‚úì Livraison {fake.city()}"
    ]
    
    closing_phrases = [
        fake.sentence(),
        f"Parfait pour {fake.bs()}",
        f"Id√©al pour {fake.job().lower()}",
        "Satisfaction garantie ou rembours√©"
    ]
    
    # Construire la description
    description_parts = [
        random.choice(opening_phrases),
        " ‚Ä¢ ".join(random.sample(features, 3)),
        random.choice(closing_phrases)
    ]
    
    return " | ".join(description_parts)

def generate_image_url():
    """G√©n√®re une URL d'image al√©atoire"""
    width = random.choice([400, 500, 600])
    height = random.choice([300, 400, 500])
    category = random.choice(['tech', 'electronics', 'gadgets', 'devices'])
    return f"https://picsum.photos/{width}/{height}?random={random.randint(1, 1000)}&category={category}"

def generate_faker_product_for_category(category_id):
    """G√©n√®re un produit enti√®rement avec Faker pour une cat√©gorie donn√©e"""
    
    # Nom g√©n√©r√© avec Faker
    name = generate_faker_product_name(category_id)
    
    # Prix selon la cat√©gorie
    price_ranges = {
        1: (200, 1500),    # T√©l√©phones
        2: (800, 3000),    # R√©frig√©rateur
        3: (600, 3500),    # Laptops
        4: (300, 4000),    # Cameras
        5: (400, 2500),    # Cuisini√®re
        6: (500, 2000),    # Air Conditioners
        8: (400, 2500)     # TVs
    }
    
    min_price, max_price = price_ranges.get(category_id, (100, 1000))
    price = round(random.uniform(min_price, max_price), 2)
    
    # Description g√©n√©r√©e avec Faker
    description = generate_faker_description()
    
    return {
        'name': name,
        'description': description[:500],  # Limiter la longueur
        'price': price,
        'img_url': generate_image_url(),
        'category_id': category_id
    }

def insert_products_to_db(products):
    """Ins√®re les produits dans la base de donn√©es"""
    try:
        connection = psycopg2.connect(
            user=USER,
            password=PASSWORD,
            host=HOST,
            port=PORT,
            dbname=DBNAME
        )
        print("‚úÖ Connexion √† la base de donn√©es r√©ussie!")
        
        cursor = connection.cursor()
        
        # Pr√©parer la requ√™te d'insertion
        insert_query = """
        INSERT INTO "Product" ("Name", "Description", "Price", "ImgUrl", "CategoryID")
        VALUES (%s, %s, %s, %s, %s)
        RETURNING "ProductID";
        """
        
        inserted_products = []
        
        for i, product in enumerate(products, 1):
            try:
                cursor.execute(insert_query, (
                    product['name'],
                    product['description'],
                    product['price'],
                    product['img_url'],
                    product['category_id']
                ))
                
                product_id = cursor.fetchone()[0]
                inserted_products.append({**product, 'product_id': product_id})
                
                print(f"‚úÖ Produit {i}/30 ins√©r√©: {product['name']} (ID: {product_id}) - {product['price']}‚Ç¨")
                
            except Exception as e:
                print(f"‚ùå Erreur lors de l'insertion du produit {i}: {e}")
                connection.rollback()
                continue
        
        # Confirmer toutes les insertions
        connection.commit()
        
        print(f"\nüéâ {len(inserted_products)} produits ont √©t√© ins√©r√©s avec succ√®s!")
        
        # Afficher un r√©sum√© par cat√©gorie
        print("\nüìä R√©sum√© par cat√©gorie:")
        for cat_id in CATEGORIES.keys():
            products_in_cat = [p for p in inserted_products if p['category_id'] == cat_id]
            count = len(products_in_cat)
            if count > 0:
                avg_price = sum(p['price'] for p in products_in_cat) / count
                print(f"  ‚Ä¢ {CATEGORIES[cat_id]['name']}: {count} produits (Prix moyen: {avg_price:.2f}‚Ç¨)")
        
        # Fermer la connexion
        cursor.close()
        connection.close()
        print("\nüîí Connexion ferm√©e.")
        
        return inserted_products
        
    except Exception as e:
        print(f"‚ùå Erreur de connexion √† la base de donn√©es: {e}")
        return []

def main():
    """Fonction principale"""
    print("üöÄ G√©n√©ration de 30 produits avec Faker UNIQUEMENT...")
    print("=" * 50)
    
    products = []
    
    # Distribuer les 30 produits sur les 7 cat√©gories de mani√®re √©quilibr√©e
    products_per_category = 30 // len(CATEGORIES)  # 4 produits par cat√©gorie
    remaining_products = 30 % len(CATEGORIES)      # 2 produits suppl√©mentaires
    
    for category_id in CATEGORIES.keys():
        # Ajouter le nombre de base de produits pour cette cat√©gorie
        for _ in range(products_per_category):
            product = generate_faker_product_for_category(category_id)
            products.append(product)
        
        # Ajouter un produit suppl√©mentaire pour les premi√®res cat√©gories
        if remaining_products > 0:
            product = generate_faker_product_for_category(category_id)
            products.append(product)
            remaining_products -= 1
    
    # M√©langer les produits pour un ordre al√©atoire
    random.shuffle(products)
    
    print(f"üì¶ {len(products)} produits g√©n√©r√©s avec Faker!")
    print("\nüíæ Insertion dans la base de donn√©es...")
    
    # Afficher quelques exemples avant insertion
    print("\nüìã Exemples de noms g√©n√©r√©s par Faker:")
    for i, product in enumerate(random.sample(products, min(5, len(products))), 1):
        cat_name = CATEGORIES[product['category_id']]['name']
        print(f"  {i}. {product['name']} - {product['price']}‚Ç¨ ({cat_name})")
    
    # Ins√©rer les produits dans la base de donn√©es
    inserted_products = insert_products_to_db(products)
    
    if inserted_products:
        print("\nüèÜ G√©n√©ration termin√©e avec succ√®s!")
    else:
        print("\n‚ùå Aucun produit n'a pu √™tre ins√©r√©.")

if __name__ == "__main__":
    main()